rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isSignedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function userRole() {
      return get(/databases/$(database)/documents/users/$(uid())).data.role;
    }
    function isAdmin() {
      return userRole() == 'ADMIN' || userRole() == 'SUPERADMIN';
    }

    // Users
    match /users/{userId} {
      allow read:  if isSignedIn() && (userId == uid() || isAdmin());
      allow write: if isSignedIn() && isAdmin();
    }

    // Admin-only collections
    match /audit_logs/{docId}   { allow read, write: if isSignedIn() && isAdmin(); }
    match /webhook_dlq/{docId}  { allow read, write: if isSignedIn() && isAdmin(); }

    // Health doc for diagnostics UI
    match /_health/{docId} {
      allow read:  if true;
      allow write: if isSignedIn() && isAdmin();
    }

    // Default deny
    match /{document=**} { allow read, write: if false; }
  }
}
